<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Supermarket Sales</title>

    <!-- Cargar Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f4f4;
        }
        h1 {
            text-align: center;
        }
        .filters-container {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        .chart-container {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>

    <h1>Dashboard — Supermarket Sales</h1>

    <!-- Filtros -->
    <div class="filters-container">
        <div class="filter-group">
            <label for="productLineFilter">Product Line:</label>
            <select id="productLineFilter">
                <option value="">Todos</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="cityFilter">City:</label>
            <select id="cityFilter">
                <option value="">Todos</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="genderFilter">Gender:</label>
            <select id="genderFilter">
                <option value="">Todos</option>
            </select>
        </div>
    </div>

    <!-- Contenedores de gráficos -->
    <div class="chart-container"><div id="chart1"></div></div>
    <div class="chart-container"><div id="chart2"></div></div>
    <div class="chart-container"><div id="chart3"></div></div>
    <div class="chart-container"><div id="chart4"></div></div>

    <script>
        // ==========================
        // Cargar dataset (CSV en GitHub)
        // ==========================

        // const URL_CSV = "supermarket_sales.csv"; 
        // Si subís el archivo a GitHub Pages, poner:
           const URL_CSV = "https://Guillermina0406.github.io/Supermarket_Sales/supermarket_sales.csv"

        Plotly.d3.csv(URL_CSV, function(err, rawData) {
            if (err) {
                console.error("Error al cargar CSV", err);
                return;
            }

            // Convertir datos
            const df = rawData.map(d => ({
                ...d,
                Total: parseFloat(d.Total),
                Date: new Date(d.Date)
            }));

            // ===============================
            // LLENAR SELECTORES DE FILTROS
            // ===============================
            const productLines = [...new Set(df.map(d => d["Product line"]))];
            const cities = [...new Set(df.map(d => d.City))];
            const genders = [...new Set(df.map(d => d.Gender))];

            productLines.forEach(pl => {
                const option = document.createElement("option");
                option.value = pl;
                option.textContent = pl;
                document.getElementById("productLineFilter").appendChild(option);
            });

            cities.forEach(city => {
                const option = document.createElement("option");
                option.value = city;
                option.textContent = city;
                document.getElementById("cityFilter").appendChild(option);
            });

            genders.forEach(gender => {
                const option = document.createElement("option");
                option.value = gender;
                option.textContent = gender;
                document.getElementById("genderFilter").appendChild(option);
            });

            // ===============================
            // FUNCIÓN PARA FILTRAR DATOS
            // ===============================
            function getFilteredData() {
                const productLine = document.getElementById("productLineFilter").value;
                const city = document.getElementById("cityFilter").value;
                const gender = document.getElementById("genderFilter").value;

                return df.filter(d => {
                    return (productLine === "" || d["Product line"] === productLine) &&
                           (city === "" || d.City === city) &&
                           (gender === "" || d.Gender === gender);
                });
            }

            // ===============================
            // FUNCIÓN PARA ACTUALIZAR GRÁFICOS
            // ===============================
            function updateCharts() {
                const filtered = getFilteredData();

                if (filtered.length === 0) {
                    alert("No hay datos para los filtros seleccionados");
                    return;
                }

                // ===============================
                // 1) TOP 3 PRODUCT LINES
                // ===============================
                let totals = {};
                filtered.forEach(d => {
                    totals[d["Product line"]] = (totals[d["Product line"]] || 0) + d.Total;
                });

                let sorted = Object.entries(totals).sort((a, b) => b[1] - a[1]).slice(0, 3);

                Plotly.newPlot("chart1", [{
                    type: "bar",
                    x: sorted.map(d => d[0]),
                    y: sorted.map(d => d[1]),
                    marker: { color: '#1f77b4' }
                }], {
                    title: "Top 3 Product Lines",
                    xaxis: { title: "Product Line" },
                    yaxis: { title: "Total Sales" }
                });

                // ===============================
                // 2) REVENUE POR CIUDAD
                // ===============================
                let city = {};
                filtered.forEach(d => {
                    city[d.City] = (city[d.City] || 0) + d.Total;
                });

                Plotly.newPlot("chart2", [{
                    type: "bar",
                    x: Object.keys(city),
                    y: Object.values(city),
                    marker: { color: '#ff7f0e' }
                }], {
                    title: "Facturación por Ciudad",
                    xaxis: { title: "City" },
                    yaxis: { title: "Total Sales" }
                });

                // ===============================
                // 3) TICKET PROMEDIO
                // ===============================
                const avg = filtered.reduce((a, b) => a + b.Total, 0) / filtered.length;

                Plotly.newPlot("chart3", [{
                    type: "indicator",
                    mode: "number",
                    value: avg.toFixed(2),
                    title: { text: "Ticket Promedio" }
                }]);

                // ===============================
                // 4) CURVA MENSUAL
                // ===============================
                let monthly = {};

                filtered.forEach(d => {
                    const ym = d.Date.getFullYear() + "-" + (String(d.Date.getMonth()+1).padStart(2,"0"));
                    monthly[ym] = (monthly[ym] || 0) + d.Total;
                });

                const months = Object.keys(monthly).sort();

                Plotly.newPlot("chart4", [{
                    type: "scatter",
                    mode: "lines+markers",
                    x: months,
                    y: months.map(m => monthly[m]),
                    line: { color: '#2ca02c' },
                    marker: { size: 8 }
                }], {
                    title: "Curva Mensual de Ventas",
                    xaxis: { title: "Mes" },
                    yaxis: { title: "Total Sales" }
                });
            }

            // ===============================
            // EVENT LISTENERS PARA FILTROS
            // ===============================
            document.getElementById("productLineFilter").addEventListener("change", updateCharts);
            document.getElementById("cityFilter").addEventListener("change", updateCharts);
            document.getElementById("genderFilter").addEventListener("change", updateCharts);

            // Cargar gráficos iniciales
            updateCharts();
        });
    </script>

</body>
</html>
