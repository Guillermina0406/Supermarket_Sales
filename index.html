<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Supermarket Sales</title>

    <!-- Cargar Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f4f4;
        }
        h1 {
            text-align: center;
        }
        .filters-container {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        .chart-container {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>

    <h1>Dashboard — Supermarket Sales</h1>

    <!-- Filtros -->
    <div class="filters-container">
        <div class="filter-group">
            <label for="productLineFilter">Product Line:</label>
            <select id="productLineFilter">
                <option value="">Todos</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="cityFilter">City:</label>
            <select id="cityFilter">
                <option value="">Todos</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="genderFilter">Gender:</label>
            <select id="genderFilter">
                <option value="">Todos</option>
            </select>
        </div>
    </div>

    <!-- Chat IA -->
    <div class="chart-container">
        <h2>Agente IA — Pregunta sobre el dataset</h2>
        <div id="chat" style="max-height:300px; overflow:auto; padding:10px; border:1px solid #eee; border-radius:6px; background:#fafafa;"></div>
        <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
            <input id="userInput" type="text" placeholder="Escribe tu pregunta..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px;" />
            <button id="sendBtn" style="padding:8px 12px;">Enviar</button>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
            <input id="useOpenAI" type="checkbox" /> <label for="useOpenAI">Usar OpenAI (vía proxy servidor)</label>
            <input id="openaiKey" type="password" placeholder="(opcional, no necesario con proxy)" style="margin-left:8px; padding:6px; border:1px solid #ddd; border-radius:5px;" />
        </div>
        <div style="font-size:12px; color:#666; margin-top:6px;">Advertencia: insertar tu API key en el navegador la expone al cliente. Para producción, usar un proxy/servidor.</div>
    </div>

    <!-- Contenedores de gráficos -->
    <div class="chart-container"><div id="chart1"></div></div>
    <div class="chart-container"><div id="chart2"></div></div>
    <div class="chart-container"><div id="chart3"></div></div>
    <div class="chart-container"><div id="chart4"></div></div>
    <div class="chart-container"><div id="chart5"></div></div>

    <script>
        // ==========================
        // Cargar dataset (CSV en GitHub)
        // ==========================

        // const URL_CSV = "supermarket_sales.csv"; 
        // Si subís el archivo a GitHub Pages, poner:
           const URL_CSV = "https://Guillermina0406.github.io/Supermarket_Sales/supermarket_sales.csv"

        Plotly.d3.csv(URL_CSV, function(err, rawData) {
            if (err) {
                console.error("Error al cargar CSV", err);
                return;
            }

            // Convertir datos
            const df = rawData.map(d => ({
                ...d,
                Total: parseFloat(d.Total),
                Date: new Date(d.Date)
            }));

            // ===============================
            // LLENAR SELECTORES DE FILTROS
            // ===============================
            const productLines = [...new Set(df.map(d => d["Product line"]))];
            const cities = [...new Set(df.map(d => d.City))];
            const genders = [...new Set(df.map(d => d.Gender))];

            productLines.forEach(pl => {
                const option = document.createElement("option");
                option.value = pl;
                option.textContent = pl;
                document.getElementById("productLineFilter").appendChild(option);
            });

            cities.forEach(city => {
                const option = document.createElement("option");
                option.value = city;
                option.textContent = city;
                document.getElementById("cityFilter").appendChild(option);
            });

            genders.forEach(gender => {
                const option = document.createElement("option");
                option.value = gender;
                option.textContent = gender;
                document.getElementById("genderFilter").appendChild(option);
            });

            // ===============================
            // FUNCIÓN PARA FILTRAR DATOS
            // ===============================
            function getFilteredData() {
                const productLine = document.getElementById("productLineFilter").value;
                const city = document.getElementById("cityFilter").value;
                const gender = document.getElementById("genderFilter").value;

                return df.filter(d => {
                    return (productLine === "" || d["Product line"] === productLine) &&
                           (city === "" || d.City === city) &&
                           (gender === "" || d.Gender === gender);
                });
            }

            // ===============================
            // FUNCIÓN PARA ACTUALIZAR GRÁFICOS
            // ===============================
            function updateCharts() {
                const filtered = getFilteredData();

                if (filtered.length === 0) {
                    alert("No hay datos para los filtros seleccionados");
                    return;
                }

                // ===============================
                // 1) TOP 3 PRODUCT LINES
                // ===============================
                let totals = {};
                filtered.forEach(d => {
                    totals[d["Product line"]] = (totals[d["Product line"]] || 0) + d.Total;
                });

                let sorted = Object.entries(totals).sort((a, b) => b[1] - a[1]).slice(0, 3);

                Plotly.newPlot("chart1", [{
                    type: "bar",
                    x: sorted.map(d => d[0]),
                    y: sorted.map(d => d[1]),
                    marker: { color: '#1f77b4' }
                }], {
                    title: "Top 3 Product Lines",
                    xaxis: { title: "Product Line" },
                    yaxis: { title: "Total Sales" }
                });

                // ===============================
                // 2) REVENUE POR CIUDAD
                // ===============================
                let city = {};
                filtered.forEach(d => {
                    city[d.City] = (city[d.City] || 0) + d.Total;
                });

                Plotly.newPlot("chart2", [{
                    type: "bar",
                    x: Object.keys(city),
                    y: Object.values(city),
                    marker: { color: '#ff7f0e' }
                }], {
                    title: "Facturación por Ciudad",
                    xaxis: { title: "City" },
                    yaxis: { title: "Total Sales" }
                });

                // ===============================
                // 3) TICKET PROMEDIO
                // ===============================
                const avg = filtered.reduce((a, b) => a + b.Total, 0) / filtered.length;

                Plotly.newPlot("chart3", [{
                    type: "indicator",
                    mode: "number",
                    value: avg.toFixed(2),
                    title: { text: "Ticket Promedio" }
                }]);

                // ===============================
                // 4) CURVA MENSUAL
                // ===============================
                let monthly = {};

                filtered.forEach(d => {
                    const ym = d.Date.getFullYear() + "-" + (String(d.Date.getMonth()+1).padStart(2,"0"));
                    monthly[ym] = (monthly[ym] || 0) + d.Total;
                });

                const months = Object.keys(monthly).sort();

                Plotly.newPlot("chart4", [{
                    type: "scatter",
                    mode: "lines+markers",
                    x: months,
                    y: months.map(m => monthly[m]),
                    line: { color: '#2ca02c' },
                    marker: { size: 8 }
                }], {
                    title: "Curva Mensual de Ventas",
                    xaxis: { title: "Mes" },
                    yaxis: { title: "Total Sales" }
                });

                // ===============================
                // 5) TORTA DE CUSTOMER TYPE
                // ===============================
                let customerType = {};
                filtered.forEach(d => {
                    customerType[d["Customer type"]] = (customerType[d["Customer type"]] || 0) + parseFloat(d.Quantity);
                });

                Plotly.newPlot("chart5", [{
                    type: "pie",
                    labels: Object.keys(customerType),
                    values: Object.values(customerType),
                    marker: { colors: ['#d62728', '#9467bd'] }
                }], {
                    title: "Unidades Vendidas por Customer Type"
                });
            }

            // ===============================
            // EVENT LISTENERS PARA FILTROS
            // ===============================
            document.getElementById("productLineFilter").addEventListener("change", updateCharts);
            document.getElementById("cityFilter").addEventListener("change", updateCharts);
            document.getElementById("genderFilter").addEventListener("change", updateCharts);

            // Cargar gráficos iniciales
            updateCharts();

            // ===============================
            // Chat IA: resumen y manejo de preguntas
            // ===============================
            const chatDiv = document.getElementById("chat");
            const userInput = document.getElementById("userInput");
            const sendBtn = document.getElementById("sendBtn");
            const useOpenAI = document.getElementById("useOpenAI");
            const openaiKeyInput = document.getElementById("openaiKey");

            function appendMessage(role, text) {
                const p = document.createElement("div");
                p.style.marginBottom = "8px";
                if (role === "user") { p.innerHTML = `<b>Tú:</b> ${text}`; }
                else p.innerHTML = `<b>IA:</b> ${text}`;
                chatDiv.appendChild(p);
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }

            function summarizeDataset() {
                const rows = df.length;
                const totalRevenue = df.reduce((s,d)=>s + (isNaN(d.Total)?0:d.Total),0);
                const avgTicket = (totalRevenue/rows) || 0;
                const products = [...new Set(df.map(d=>d["Product line"]))];
                const cities = [...new Set(df.map(d=>d.City))];
                const genders = [...new Set(df.map(d=>d.Gender))];
                const dateMin = new Date(Math.min(...df.map(d=>d.Date.getTime())));
                const dateMax = new Date(Math.max(...df.map(d=>d.Date.getTime())));
                return {
                    rows, totalRevenue, avgTicket, products, cities, genders, dateMin, dateMax
                };
            }

            const datasetSummary = summarizeDataset();

            function answerFromLocal(question) {
                const q = question.toLowerCase();
                if (q.includes("filas") || q.includes("registros") || q.includes("rows")) {
                    return `El dataset tiene ${datasetSummary.rows} filas (registros).`;
                }
                if (q.includes("total") || q.includes("ingreso") || q.includes("ventas totales") || q.includes("facturación")) {
                    return `Ventas totales: ${datasetSummary.totalRevenue.toFixed(2)}`;
                }
                if (q.includes("promedio") || q.includes("ticket")) {
                    return `Ticket promedio: ${datasetSummary.avgTicket.toFixed(2)}`;
                }
                if (q.includes("product") || q.includes("producto") || q.includes("line")) {
                    return `Product lines (${datasetSummary.products.length}): ${datasetSummary.products.join(", ")}`;
                }
                if (q.includes("ciudad") || q.includes("city")) {
                    return `Ciudades (${datasetSummary.cities.length}): ${datasetSummary.cities.join(", ")}`;
                }
                if (q.includes("gender") || q.includes("genero") || q.includes("género")) {
                    return `Géneros en el dataset: ${datasetSummary.genders.join(", ")}`;
                }
                if (q.includes("rango") || q.includes("fechas") || q.includes("fecha")) {
                    return `Rango de fechas: ${datasetSummary.dateMin.toISOString().slice(0,10)} a ${datasetSummary.dateMax.toISOString().slice(0,10)}`;
                }
                return null;
            }

            async function callOpenAI(question) {
                // En este modo usamos el proxy servidor que expone /api/chat
                const sample = df.slice(0,10).map(d => ({Date: d.Date.toISOString().slice(0,10), City: d.City, Product: d["Product line"], Quantity: d.Quantity, Total: d.Total, Gender: d.Gender, CustomerType: d["Customer type"]}));

                const payload = {
                    question,
                    summary: {
                        rows: datasetSummary.rows,
                        totalRevenue: datasetSummary.totalRevenue,
                        avgTicket: datasetSummary.avgTicket,
                        products: datasetSummary.products,
                        cities: datasetSummary.cities,
                        genders: datasetSummary.genders,
                        dateMin: datasetSummary.dateMin.toISOString().slice(0,10),
                        dateMax: datasetSummary.dateMax.toISOString().slice(0,10)
                    },
                    sample
                };

                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const t = await resp.text();
                    throw new Error(t || 'Error en la llamada al proxy');
                }

                const data = await resp.json();
                return (data.reply || JSON.stringify(data)).trim();
            }

            async function handleQuestion(q) {
                appendMessage("user", q);
                appendMessage("ia", "Pensando...");

                const local = answerFromLocal(q);
                if (local && !useOpenAI.checked) {
                    chatDiv.lastChild.remove();
                    appendMessage("ia", local);
                    return;
                }

                if (useOpenAI.checked) {
                    try {
                        const ans = await callOpenAI(q);
                        chatDiv.lastChild.remove();
                        appendMessage("ia", ans);
                        return;
                    } catch (e) {
                        chatDiv.lastChild.remove();
                        appendMessage("ia", `Error llamando OpenAI: ${e.message}`);
                        return;
                    }
                }

                chatDiv.lastChild.remove();
                appendMessage("ia", "No puedo responder esa pregunta localmente. Marca 'Usar OpenAI' y provee una API key para respuestas más completas.");
            }

            sendBtn.addEventListener("click", ()=>{ const q = userInput.value.trim(); if (!q) return; userInput.value=''; handleQuestion(q); });
            userInput.addEventListener("keydown", (e)=>{ if (e.key === 'Enter') { const q = userInput.value.trim(); if (!q) return; userInput.value=''; handleQuestion(q); } });
        });
    </script>

</body>
</html>
